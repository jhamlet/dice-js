
var Behavior = require("dice-js/behavior"),
    Factory  = require("dice-js/factory"),
    dutil    = require("dice-js/util"),
    faces    = [4, 6, 8, 10, 12, 20, 100]
;

//---------------------------------------------------------------------------
// Behaviors
//---------------------------------------------------------------------------
new Behavior("Exploding", {
    
    abbreviation: "e",
    
    reset: function (dice, value) {
        delete dice.exploded;
    },
    
    roll: function (dice, value) {
        dice.exploded = [];
    },
    
    results: function (dice, value) {
        var exploded = dice.exploded,
            faces = dice.faces,
            rand = dutil.randomNumber
        ;

        if (!exploded.length) {
            value.forEach(function (result) {
                while (result === faces) {
                    result = rand(1, faces);
                    exploded.push(result);
                }
            });
        }
        
        return value.concat(exploded);
    },
    
    result: function (dice, value) {
        return dice.exploded.reduce(function (acc, result) {
            return (acc + result);
        }, value);
    }
});

new Behavior("Open", {
    
    abbreviation: "o",
    
    results: function (dice, value) {
        var faces = dice.faces,
            rand  = dutil.randomNumber,
            roll
        ;
        
        return value.map(function (acc, result) {
            if (result === faces) {
                result = [result];
                while ((roll = rand(1, faces)) === faces) {
                    result.push(roll);
                }
            }
            return result;
        });
    },
    
    result: function (dice, value) {
        var isArray = Array.isArray;
        
        return dice.results.map(function (result) {
                if (isArray(result)) {
                    return result.reduce(dutil.reduceSum, 0);
                }
                return result;
            }).sort(dutil.ascendingNumericSort)[0];
    }
});


//---------------------------------------------------------------------------
// Factories
//---------------------------------------------------------------------------
faces.forEach(function (faces) {
    new Factory("ExplodingD" + faces, faces, "Exploding");
    new Factory("OpenD" + faces, faces, "Open");
});
