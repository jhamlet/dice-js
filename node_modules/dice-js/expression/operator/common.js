
var Operator = require("dice-js/expression/operator");

function operateOn (op, lValue, rValue) {
    switch (op) {
        case "+":
            return lValue + rValue;
        case "-":
            return lValue - rValue;
        case "/":
            return lValue / rValue;
        case "*":
            return lValue * rValue;
    }
}

function commonOperation (lVal, rVal) {
    var op          = this.symbol,
        lValue      = lVal.valueOf(),
        rValue      = rVal.valueOf(),
        lValIsArray = Array.isArray(lValue),
        rValIsArray = Array.isArray(rValue),
        lValIsObj   = typeof lValue === "object",
        rValIsObj   = typeof rValue === "object"
    ;
    
    if (lValIsArray) {
        if (rValIsArray) {
            return rValue.map(function (val, idx) {
                if (typeof lValue[idx] === "undefined") {
                    return val;
                }
                else {
                    return operateOn(op, lValue[idx], val);
                }
            });
        }
        else if (rValIsObj) {
            return [lValue, rValue];
        }
        else {
            return lValue.map(function (val) {
                return operateOn(op, val, rValue);
            });
        }
    }
    else if (lValIsObj) {
        if (rValIsArray || !rValIsObj) {
            return [lValue, rValue];
        }
        else {
            return Object.keys(rValue).reduce(function (acc, key) {
                if (acc[key] !== undefined) {
                    acc[key] = operateOn(op, acc[key], rValue[key]);
                }
                else {
                    acc[key] = rValue[key];
                }
                return acc;
            }, Object.keys(lValue).reduce(function (acc, key) {
                acc[key] = lValue[key];
                return acc;
            }, {}));
        }
    }
    else {
        return operateOn(op, lValue, rValue);
    }
}

Operator.define("Addition", {
    symbol:         "+",
    precedence:     0,
    associativity:  "left",
    operation:      commonOperation
});

Operator.define("Subtraction", {
    symbol:         "-",
    precedence:     0,
    associativity:  "left",
    operation:      commonOperation
});

Operator.define("Multiplication", {
    symbol:         "*",
    precedence:     0,
    associativity:  "left",
    operation:      commonOperation
});

Operator.define("Division", {
    symbol:         "/",
    precedence:     0,
    associativity:  "left",
    operation:      commonOperation
});
