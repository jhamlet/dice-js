
var Proteus = require("proteus"),
    FORMAT_REGEX = /%(.)(\d+)?/g,
    FORMATS = {}
;

function formatReplace (match, token) {
    var fn = FORMATS[token],
        args = Proteus.slice(arguments, 2)
    ;
    
    if (!fn) {
        throw "Unknown format token '%" + token + "'.";
    }

    return fn.apply(this, args);
}

function format (dice, fmt) {
    return fmt.replace(FORMAT_REGEX, formatReplace.bind(dice));
}

function addFormat (token, fn) {
    if (!FORMATS[token]) {
        FORMATS[token] = fn;
    }
    else {
        throw "Format token '" + token + "' already defined.";
    }
}

Proteus.extend(format, { add: addFormat });

addFormat("s", function () {
    return this.sides;
});

addFormat("c", function () {
    return this.count;
});

addFormat("r", function () {
    return this.results.join(", ");
});

addFormat("t", function () {
    return this.valueOf();
});

addFormat("d", function (idx) {
    idx = parseInt(idx, 10) || 0;
    return this.results[idx];
});

module.exports = format;